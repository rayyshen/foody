<!DOCTYPE html>
<html>

<meta charset="UTF-8">

<head>
    <title>Foody</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
        <div class="w3-display-topleft w3-padding-large w3-xxlarge title">
            <a href="http://127.0.0.1:5500/index.html" style="text-decoration: none;">Foody</a>
        </div>
        <div class="w3-display-middle">
            <input type="text" class="input-field" id="input" style="display: none"><br>
            <button onClick="enterBarcode()" class="scan-button button" id="scan-button">Enter Barcode</button>
            <button onClick="scanBarcode()" class="scan-button button" id="enter-button">Scan Barcode</button>
            <button onClick="tempFunction(document.getElementById('input').value)" class="scan-button button" id="submit"
                style="display: none;">Submit</button>
        </div>
        <div id="qr-reader" style="width: 600px" class="w3-display-bottommiddle " id="video"></div>
        <div class="w3-display-bottomleft w3-padding-large">
            Made with &#128155; by Ray and Sriram
        </div>
    </div>

    <div class="w3-display-bottommiddle">
        <button onClick="redirect()" class="scan-button button" style="display: none" id="donate">
            Donate to Food Pharmacy
        </button>
    </div>
    <!-- 5449000131805  -->

    <!-- 028400069311  Doritos -->

    <!-- <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>test</p>
        </div>
    </div> -->

    <div class="w3-display-left" id="imgdiv" style="display: none">
        <img class="img" id="img" src="">
    </div>
    <div class="w3-display-middle table" style="display: none" id="table">
        <table class="table-content">
            <thead>
                <tr>
                    <th colspan="2" id="header" class="header"></th>
                </tr>
            </thead>
            <tr>
                <th>Macronutrient</th>
                <th>Amount Per Serving<span id="serving"></span></th>
            </tr>
            <tr>
                <td>Energy</td>
                <td id="engy"></td>
            </tr>
            <tr>
                <td>Carbohydrates</td>
                <td id="carb"></td>
            </tr>
            <tr>
                <td>Protein</td>
                <td id="protein"></td>
            </tr>
            <tr>
                <td>Fats</td>
                <td id="fat"></td>
            </tr>
            <tr>
                <td>Sugars</td>
                <td id="sugar"></td>
            </tr>
            <tr>
                <td>Sodium</td>
                <td id="soda"></td>
            </tr>
            <tr>
                <td>Nutriscore</td>
                <td id="score"></td>
            </tr>
            <tfoot>
                <tr>
                    <th colspan="2" id="foot"></th>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="w3-display-topright" id="translate">
        <!-- <button class="scan-button button">
            Translate
        </button> -->
        <div id="google_translate_element"></div>
    </div>

    <div class="w3-display-bottomright" style="display: none" id="readout">
        <button onClick="speak()" class="scan-button button" id="speak">
            Read Out
        </button>
    </div>


    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script src="https://github.com/mebjas/html5-qrcode/releases/download/v2.3.7/html5-qrcode.min.js"></script>

    <script>

        function tempFunction(data) {
            var baseURL = "https://world.openfoodfacts.org/api/v2/product/" + data;
            const userAction = async () => {
                const response = await fetch(baseURL);
                const myJson = await response.json(); //extract JSON from the http response
                // do something with myJson
                return myJson;
            }
            // const myJson = await response.json(); //extract JSON from the http response
            // do something with myJson
            // console.log(myJson);
            // return myJson;
            // };

            userAction().then(data => {
                hideElements();
                var servingSize = data.product.serving_quantity;
                var num = servingSize / 100;
                var carbs = data.product.nutriments.carbohydrates_100g;
                var energy = data.product.nutriments.energy_100g;
                var fat = data.product.nutriments.fat_100g;
                var proteins = data.product.nutriments.proteins_100g;
                var score = data.product.nutriscore_grade;
                var sodium = data.product.nutriments.sodium_100g;
                var imgURL = data.product.image_url;
                var productName = data.product.product_name_en;
                var sugars = data.product.nutriments.sugars;
                console.log(imgURL);
                document.getElementById("serving").innerHTML = "(" + servingSize + ")";
                document.getElementById("engy").innerHTML = Math.round(energy * num / 4.184) + " Calories";
                document.getElementById("carb").innerHTML = Math.round(carbs * num) + " Grams";
                document.getElementById("protein").innerHTML = Math.round(proteins * num) + " Grams";
                document.getElementById("fat").innerHTML = Math.round(fat * num) + " Grams";
                document.getElementById("soda").innerHTML = Math.round(sodium * num * 1000) + " Milligrams";
                document.getElementById("score").innerHTML = score;
                if(( window.innerWidth <= 1200 ) && ( window.innerHeight <= 1000 )){
                    document.getElementById("imgdiv").style.display = "none";
                }
                else{
                    document.getElementById("imgdiv").style.display = "block";
                    document.getElementById("img").src = imgURL;
                }
                document.getElementById("sugar").innerHTML = Math.round(sugars) + " Grams";
                document.getElementById("foot").innerHTML = footerResponse(fat, sodium, score);
                document.getElementById("header").innerHTML = productName;
                document.getElementById("table").style.display = "block";
                document.getElementById("img").style.display = "block";
                document.getElementById("readout").style.display = "block";

            })

        }

        function hideElements() {
            document.getElementById("input").style.display = "none";
            document.getElementById("scan-button").style.display = "none";
            document.getElementById("enter-button").style.display = "none";
            document.getElementById("submit").style.display = "none";
            
        }

        function footerResponse(f, s, sc) {
            if (f > 10 || s > 500 || sc === "e" || sc === "d" || sc === "c") {
                return "This item is not recommended for children with diabetes or pre-diabetes";
            }
            else {
                document.getElementById("donate").style.display = "block";
                return "This item is safe to consume in moderation for children with diabetes or pre-diabetes";
            }
        }

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'en' }, 'google_translate_element');
        }

        function redirect() {
            window.location.href = "https://www.capitalareafoodbank.org/how-to-help/donate-food/";
        }

        function enterBarcode() {
            document.getElementById("enter-button").style.display = "none";
            document.getElementById("scan-button").style.display = "none";
            document.getElementById("submit").style.display = "block";
            document.getElementById("input").style.display = "block";
        }

        function scanBarcode() {
            hideElements();
            function onScanSuccess(decodedText, decodedResult) {
                console.log(`Code scanned = ${decodedText}`, decodedResult);
                document.getElementById("qr-reader").style.display="none";
                tempFunction(decodedText);
            }
            var html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", {
                fps: 10, qrbox: 300, useBarCodeDetectorIfSupported: true,
                showTorchButtonIfSupported: true,
            });
            html5QrcodeScanner.render(onScanSuccess);
        }

        function speak(){
            document.getElementById('speak').innerHTML = "Stop Speaking";

            let speech = new SpeechSynthesisUtterance();
            let combo = document.getElementsByClassName('goog-te-combo')[0];

            speech.lang = combo.value;
            speech.text = document.getElementById("header").innerHTML + " has a serving size of " + document.getElementById("serving").innerHTML + " grams. The energy value that is provided is " + document.getElementById("engy").innerHTML + ". The amount of carbohydrates contained is " + document.getElementById("carb").innerHTML + ". The amount of protein contained is " + document.getElementById("protein") + ". The amount of fat contained is " + document.getElementById("fat").inner + ". The amount of sodium contained is " + document.getElementById("soda").innerHTML + ". The nutriscore of this food is " + document.getElementById("score").innerHTML + ". " + document.getElementById("foot").innerHTML;
            if(window.speechSynthesis.speaking){
                window.speechSynthesis.cancel();
                document.getElementById('speak').innerHTML = "Start Speaking";
            }
            else {
                window.speechSynthesis.speak(speech);
            }
        }


        // var modal = document.getElementById("myModal");
        // var btn = document.getElementById("donate");
        // var span = document.getElementByClassName("close")[0];

        // btn.onclick = function () {
        //     modal.style.display = "block";
        // }

        // span.onClick = function () {
        //     modal.style.display = "none";
        // }

        // window.onclick = function (event) {
        //     if (event.target == modal) {
        //         modal.style.display = "none";
        //     }
        // }



    </script>

</body>

</html>